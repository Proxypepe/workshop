---
tags:
  - coreDNS
  - kubernetes
---

## Tutorial
https://coredns.io/2017/07/24/quick-start/


https://coredns.io/manual/toc/#what-is-coredns
https://kubernetes.io/docs/tasks/administer-cluster/coredns/
https://waytoeasylearn.com/learn/core-dns-in-kubernetes/


## Страничка




CoreDNS - это программное обеспечение DNS-сервера, которое часто используется для поддержки функции обнаружения служб в контейнерных средах, особенно в средах, управляемых Kubernetes. Оно было создано Миком Гибеном (Miek Gieben) в 2016 году. Ранее он уже разрабатывал DNS-сервер под названием SkyDNS и популярную библиотеку функций DNS на языке Go, называемую Go DNS. SkyDNS, как и его преемник CoreDNS, использовался в основном для поддержки обнаружения служб.

Однако Мик Гибен вдохновился архитектурой веб-сервера на языке Go под названием Caddy и решил создать CoreDNS, форкнув Caddy. CoreDNS таким образом унаследовал основные преимущества Caddy: простой синтаксис конфигурации, мощную архитектуру на основе плагинов и основу на языке Go.

Основные характеристики CoreDNS, такие как его гибкая настройка, расширяемость через плагины и надежность, делают его идеальным выбором для обеспечения DNS-сервисов в контейнерных и микросервисных средах, включая среды, управляемые Kubernetes. CoreDNS играет важную роль в обеспечении надежного и гибкого разрешения DNS-имен в таких современных сетевых сценариях.

На данный момент у CoreDNS есть несколько существенных ограничений, и оно не будет подходить для каждого возможного DNS-сервера. Главным из них является то, что CoreDNS, по крайней мере, в последней версии на момент написания этого сообщения, не поддерживает полную рекурсию. Иными словами, CoreDNS не может обработать запрос, начиная с корня пространства имен DNS, запрашивая корневой DNS-сервер и следуя по перенаправлениям до получения ответа от одного из авторитетных DNS-серверов. Вместо этого он полагается на другие DNS-серверы, обычно называемые пересыльщиками (forwarders).


| |CoreDNS|BIND|
|---|---|---|
|Full recursion|No|Yes|
|Dynamic updates|No|Yes|
|Integration with Kubernetes|Yes|No|
|Integration with Amazon Route 53|Yes|No|
|Domain Name System Security Extensions (DNSSEC) support|Limited|Full|
|Support for DNS over Transport Layer Security (DoT)|Yes|No|


# Domain Names and the Namespace

## DNS

Что такое днс
Базовые понятия
Характеристики, что такое рекурсивный днс
Какие протоколы и порты использует
Схема обменом сообщений
Стандартная запись
Виды записей

Общая информация

DNS (Domain Name System) - это система доменных имен, используемая в интернете и других сетях для преобразования человеко-читаемых доменных имен (например, [www.example.com](http://www.example.com/)) в IP-адреса и наоборот. DNS позволяет пользователям и компьютерам находить ресурсы в сети, используя удобные для запоминания доменные имена вместо числовых IP-адресов.

DNS использует два основных протокола:

1. **UDP (User Datagram Protocol)**: DNS обычно использует UDP для запросов и ответов. UDP - это протокол без установления соединения, что делает его быстрым и эффективным, но менее надежным в случае потери данных. Порт, который обычно используется для DNS, - это порт 53.
    
2. **TCP (Transmission Control Protocol)**: DNS также может использовать TCP для обмена данными в случаях, когда размер ответа DNS превышает размер, который может быть передан через UDP. Это обеспечивает надежную передачу данных, но менее эффективно по сравнению с UDP. Порт 53 также используется для DNS-запросов и ответов через TCP.
    

DNS работает на принципе клиент-сервер, где DNS-клиенты (резолверы) отправляют запросы DNS-серверам, чтобы получить информацию о доменных именах. DNS-серверы занимаются разрешением запросов и предоставляют ответы, содержащие соответствующие IP-адреса или другую информацию о доменных именах.

Порт 53 является стандартным портом для DNS, и он используется как для UDP, так и для TCP, взаимодействия между клиентами и серверами DNS.

  
Протокол DNS (Domain Name System) может использовать как UDP (User Datagram Protocol), так и TCP (Transmission Control Protocol), в зависимости от конкретных условий и требований:

1. **UDP (User Datagram Protocol)**:
    
    - UDP используется для большинства DNS-запросов и ответов.
    - Он предпочтителен для обычных DNS-транзакций, так как UDP - это протокол без установления соединения, и он более легковесен и быстр, чем TCP.
    - UDP используется, когда размер DNS-ответа помещается в стандартный UDP-пакет (обычно 512 байт или больше, если поддерживается EDNS).
    - Однако UDP имеет ограничение по размеру пакета, и если ответ DNS превышает это ограничение, то может использоваться TCP.
2. **TCP (Transmission Control Protocol)**:
    
    - TCP используется в случаях, когда размер ответа DNS превышает ограничение UDP, которое может возникнуть, например, при больших DNS-запросах или при использовании DNSSEC (DNS Security Extensions), что добавляет цифровую подпись к DNS-записям и увеличивает размер ответа.
    - TCP обеспечивает надежную передачу данных, что важно в случаях, когда целостность данных DNS является приоритетом.
    - Другими словами, если размер DNS-ответа превышает ограничение UDP, клиент и сервер переключаются на использование TCP для обмена данными.

В большинстве обычных сценариев и запросов DNS используется UDP, так как большинство DNS-запросов имеют небольшой размер ответа и могут быть обработаны без использования TCP. Однако при работе с большими и сложными DNS-запросами или при использовании расширений DNS, таких как DNSSEC, TCP может стать необходимым.

# DNS Servers
DNS-серверы выполняют две основные функции: отвечают на запросы о доменных именах и сами запрашивают информацию у других DNS-серверов о доменных именах.

DNS-серверы могут загружать данные зоны из файлов, называемых, как следует из названия, файлами данных зоны или, равнозначно, мастер-файлами. Каждый файл данных зоны содержит полное описание зоны: все записи, привязанные к доменным именам в этой зоне. DNS-сервер, который загружает информацию о зоне из файла данных зоны, называется первичным DNS-сервером для этой зоны.

# Resolvers
Резолверы (DNS-клиенты) принимают запросы приложений о получении информации о доменном имени и преобразуют их в DNS-запросы. Затем они отправляют эти запросы DNS-серверам и ожидают ответов. Если резолвер не получает ответ на конкретный запрос в разумное время (обычно в течение одной или нескольких секунд), он может повторно отправить запрос на тот же DNS-сервер или попробовать обратиться к другому DNS-серверу. Когда резолвер получает ответ, он распаковывает его в структуру данных и передает ее обратно в приложение. Некоторые резолверы выполняют дополнительные действия, включая кэширование недавно полученных ответов.


## Формат пакета DNS

![[Pasted image 20230911170059.png]]
### Типы служб DNS

**Авторитативный DNS-сервис.** **Авторитативный DNS-сервис** предоставляет механизм обновления, используемый разработчиками для управления публичными именами DNS. Она отвечает на запросы к DNS, преобразуя доменные имена в IP‑адреса, чтобы обеспечить взаимодействие компьютеров между собой. Авторитативный DNS-сервис полностью отвечает за домен и предоставляет информацию об IP-адресах в ответ на запросы **рекурсивных DNS-серверов**. **Amazon Route 53 является авторитативным DNS-сервисом.**

**Рекурсивный DNS-сервис.** Обычно клиенты не отправляют запросы напрямую к авторитативным DNS-сервисам. Вместо этого они взаимодействуют с другим DNS-сервисом, который называется **преобразователь имен** или **рекурсивный DNS-сервис**. Рекурсивный DNS-сервис похож на управляющего в отеле: сам он не хранит записи DNS, но действует в качестве посредника, который может достать нужную информацию для вас. Если рекурсивный DNS-сервис хранит информацию в **кэше** или постоянном хранилище в течение определенного времени, тогда он отвечает на DNS-запрос, возвращая информацию об источнике или IP-адрес. Если он не хранит эту информацию, он передает запрос в один или несколько авторитативных DNS-серверов.

## Zone

Зона (zone) - это домен минус поддомены, которые были делегированы в другие места. Однако, если внутри домена не производится делегации, в таком случае домен и зона содержат одни и те же узлы. Например, если ниже домена cs.berkeley.edu не происходит дополнительной делегации, то домен cs.berkeley.edu и зона cs.berkeley.edu фактически остаются одним и тем же.

DNS-серверы также могут загружать данные зоны из других DNS-серверов с помощью механизма, называемого передачей зоны (zone transfer). DNS-сервер, который загружает информацию о зоне из другого DNS-сервера с использованием передачи зоны, называется вторичным DNS-сервером для этой зоны. DNS-сервер, с которого вторичный DNS-сервер передает зону, называется его мастер DNS-сервером.

После передачи зоны, вторичный DNS-сервер может сохранить копию данных зоны на диске, иногда в так называемом резервном файле данных зоны (backup zone data file). Когда вторичный DNS-сервер периодически передает новую версию зоны от своего мастер DNS-сервера, он обновляет данные на диске. Резервные данные полезны, если вторичный DNS-сервер должен перезапуститься, потому что он может сначала загрузить резервные данные, а затем проверить, актуальны ли они по сравнению с версией зоны на мастер DNS-сервере. Если данные актуальны, передача зоны не требуется. И если мастер DNS-сервер недоступен, у вторичного DNS-сервера все равно есть данные зоны, на которые он может отвечать.

![[Pasted image 20230911165706.png]]

  
Оба первичный и вторичный DNS-серверы для зоны считаются авторитетными для этой зоны. Это означает, что они могут однозначно отвечать на любой запрос о доменном имени в этой зоне.  Один DNS-сервер может быть авторитетным для множества зон одновременно и может быть первичным для одних и вторичным для других. 


# Resolution and Recursion

Разрешение (resolution) - это процесс, в котором резолверы и DNS-серверы сотрудничают для поиска ответов (в форме ресурсных записей), хранящихся в распределенной базе данных DNS. Иногда разрешение бывает простым: резолвер отправляет запрос DNS-серверу от имени приложения, и DNS-сервер является авторитетным для зоны, которая содержит доменное имя в запросе, поэтому он напрямую отвечает резолверу с записями, составляющими ответ. Однако в случаях, когда DNS-сервер не является авторитетным для зоны, содержащей ответ, процесс разрешения более сложный.

По умолчанию процесс разрешения происходит сверху вниз в пространстве имен DNS. Напомним, что пространство имен представляет собой инвертированное дерево: начиная с вершины инвертированного дерева, можно дойти до любого узла. И доменное имя в запросе указывает DNS-серверу, по какой "ветви" следовать от каждого узла, как показано в тексте.

![[Pasted image 20230911170648.png]]

DNS-сервер может начать процесс разрешения, отправив запрос любому из корневых DNS-серверов. Вероятно, корневой DNS-сервер не будет авторитетным для зоны, содержащей доменное имя в запросе, но он, по крайней мере, знает DNS-серверы, авторитетные для верхнего уровня зоны (например, com, net), под которой находится это доменное имя. Корневой DNS-сервер вернет список DNS-серверов, авторитетных для соответствующей верхней зоны, в виде референса (referral) для запрашивающего DNS-сервера. Референс также содержит NS-записи для верхней зоны.

DNS-сервер продолжает запрос, обращаясь к одному из DNS-серверов верхней зоны, следуя референсам, пока он не достигнет DNS-серверов, авторитетных для доменного имени в запросе. Когда он обращается к одному из этих DNS-серверов, он должен получить ответ, а не референс, как показано на рисунке.

![[Pasted image 20230911170741.png]]

Процесс, который первый DNS-сервер выполняет, начиная с корневых DNS-серверов и следуя референсам до получения ответа, называется рекурсией (recursion). 



```
[NAME] [TTL] [CLASS] TYPE RDATA
```

```
@             3600  IN  A  10.0.0.1  # TTL 3600 секунд или 1 час
              1h    IN  A  10.0.0.2  # То же самое
www           1h30m IN  A  10.0.0.3  # TTL 1 час 30 минут или 90 минут
                    IN  A  10.0.0.4  # TTL из предыдущей записи, то есть 90 минут.
```
## Name
Поле NAME содержит доменное имя, к которому прикреплена эта ресурсная запись. Это может быть полностью квалифицированным доменным именем (FQDN), заканчивающимся точкой, или относительным доменным именем, которое не заканчивается точкой. Относительные доменные имена интерпретируются как заканчивающиеся текущим исходным значением (origin), которое по умолчанию является доменным именем зоны, описываемой файлом данных зоны. Это удобно, потому что при написании файла данных зоны для, например, foo.example, вы не захотели бы каждый раз вводить "foo.example" в конце каждого имени.

Если вы хотите обратиться к самому исходному значению (origin), а не иметь его добавленным к введенному имени, вы используете символ "@" в поле NAME, без завершающей точки. Вы также можете использовать одиночную точку ("."), чтобы обратиться к корню, хотя обычно вы бы не использовали это в поле NAME ресурсной записи, если бы не редактировали файл данных корневой зоны или файл подсказок для корня.

Как видно из формата, который мы показали вам недавно, поле NAME является необязательным. Если поле NAME опущено, строка должна начинаться с пробелов, и ресурсная запись, указанная в строке, прикрепляется к самому недавно указанному доменному имени.

## TTL
  
Поле TTL (Time to Live) определяет значение времени жизни ресурсной записи, которое регулирует, как долго рекурсивный DNS-сервер может кэшировать эту запись. TTL изначально (то есть на уровне данных, передаваемых по сети) представляет собой 32-битное целое число секунд, и вы можете указывать TTL в таком формате. Однако теперь также существуют масштабные факторы, такие как "s" для секунд, "m" для минут, "h" для часов, "d" для дней и "w" для недель, например, "1d", "30m" или "1h30m". Это позволяет избежать необходимости запоминать, скажем, "В сутках 86400 секунд".

## CLASS

Как упоминалось ранее в этой главе, поле CLASS почти всегда устанавливается в IN, что означает Internet, поэтому неудивительно, что IN является значением по умолчанию. Существуют и другие классы, такие как CH для ChaosNet и HS для Hesiod, но их использование крайне редко, потому что функции, которые предназначались для обслуживания этих других классов, никогда не получили широкого распространения.

# Resource Record Types

1. **A (IPv4 address)**:
    - Сопоставляет доменное имя с одним IPv4-адресом.
    - Используется для разрешения доменных имен в IPv4-адреса.
2. **AAAA (IPv6 address)**:
    - Сопоставляет доменное имя с одним IPv6-адресом.
    - Используется для разрешения доменных имен в IPv6-адреса.
3. **CNAME (alias)**:
    - Сопоставляет доменное имя (псевдоним) с другим доменным именем (каноническим именем).
    - Используется для создания алиасов или перенаправлений на другие доменные имена.
4. **MX (mail exchanger)**:
    - Указывает на почтовый обменник (почтовый сервер) для адресата электронной почты.
    - Помогает маршрутизировать почту к правильному почтовому серверу.
5. **NS (name server)**:
    - Указывает на DNS-сервер (или имя сервера) для конкретной зоны.
    - Используется для определения авторитетных DNS-серверов для данной зоны.
6. **PTR (pointer)**:
    - Сопоставляет IP-адрес обратно в доменное имя.
    - Используется для выполнения обратного DNS-разрешения.
7. **SOA (start of authority)**:
    - Предоставляет параметры и информацию о зоне, такие как имя владельца зоны, адрес электронной почты владельца, номер версии и другие параметры.
    - Используется для определения авторитета для данной зоны.
