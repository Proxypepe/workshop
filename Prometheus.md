**Prometheus** — это система мониторинга и оповещений, хранящая и обрабатывающая метрики, собираемые из экспортеров в Time Series Database (TSDB). В отличие от SQl-like СУБД, Prometheus сам собирает метрики по указанным хостам.

Для работы с метриками в Prometheus используется язык запрос PromQL. Он позволяет составлять сложные запросы и использовать математические операторы. Результат запроса может быть выведен в табличной или графической форме.

Сами данные хранятся в виде набора файлов на жестком диске сервера, где установлен Prometheus. Через конфигурационный файл Prometheus можно настроить длительность хранения данных и задать объём дискового пространства для хранения данных.

Также Prometheus может оповещать, о различных событиях, которые настраиваются администратором Prometheus в специальном конфигурационном файле alerts. Для удобной и корректной работы системы оповещения применяется специальное расширение — AlertManager.

Основные понятия
1. Метрика - Метрика – это конкретная характеристика, показывающая текущее состояние по определенному параметру (_пример: количество одновременных подключений_);
2. Параметр
3. Логирование
4. Трассировка
5. Оповещение: Это непрерывная проверка метрик или логов на соответствие пороговым значениям и вызывает действие или уведомление в случае нарушения установленного порога.
6. - Сервер мониторинга – ПО, которое выполняет агрегацию, хранение, пересчет данных по метрикам;
7. Агент мониторинга – ПО, которое выполняет сбор метрик с хоста, который подлежит мониторингу, а так же отправку данных на сервер мониторинга;
8. Визуализация: Это графическое представление метрик, логов или трейсов.
9. SLA
10. SLO
11. SLI
12. Push versus pull
13. Что мерить: Методики google, use, red

https://www.atlassian.com/incident-management/kpis/sla-vs-slo-vs-sli
https://www.blameless.com/blog/sla-vs-slo


**Push-стратегия мониторинга (Push Monitoring Strategy):** В этой стратегии данные активно отправляются или "пушатся" от источника данных к системе мониторинга. Это означает, что источник данных инициирует передачу информации в систему мониторинга по мере появления новых данных или событий.

**Pull-стратегия мониторинга (Pull Monitoring Strategy):** В этой стратегии система мониторинга "тянет" данные из источника по запросу. То есть, система мониторинга периодически опрашивает источники данных, чтобы получить актуальную информацию. Этот метод полезен, когда данные не поступают непрерывно, и нет необходимости в мгновенной передаче.

![[Pasted image 20230917214435.png]]


## Архитектура

![[Pasted image 20230917212627.png]]

1. Компоненты
2. Как работает бд

1. **Prometheus Server (Сервер Prometheus):** Это центральный компонент системы Prometheus. Он отвечает за сбор, хранение и обработку данных мониторинга. Prometheus Server выполняет следующие функции:
    
    - Сбор данных: Он периодически собирает метрики от различных целей мониторинга, таких как приложения, серверы и сервисы.
    - Хранение данных: Он сохраняет собранные данные в свой собственной временной базе данных.
    - Операции над данными: Prometheus Server позволяет выполнять различные операции над данными, включая агрегацию, фильтрацию и вычисление предупреждений.
2. **PromQL (Prometheus Query Language):** Это язык запросов, который позволяет пользователю формулировать запросы к данным, хранящимся в системе Prometheus. С помощью PromQL вы можете выполнять запросы, создавать выражения для агрегации данных и создавать правила предупреждений.
3. **Exporter (Экспортер):** Экспортеры - это дополнительные компоненты или приложения, которые позволяют собирать метрики из различных систем и приложений, которые не являются нативно совместимыми с Prometheus. Экспортеры работают как мост между Prometheus и источниками данных. Например, существуют экспортеры для сбора метрик из баз данных, веб-серверов, облачных сервисов и других систем. Эти экспортеры предоставляют HTTP-интерфейс, на который Prometheus Server может отправлять запросы для получения данных.
4. **Collector (Сборщики):** Сборщики - это компоненты, которые собирают метрики от различных источников и предоставляют их Prometheus Server. Существуют стандартные сборщики для сбора данных о системе, такие как сведения о CPU, памяти и дисках. Также можно создавать собственные сборщики для сбора данных о приложениях и сервисах.
5. **Alertmanager:** Этот компонент отвечает за управление и отправку оповещений и предупреждений на основе данных, собранных Prometheus. Alertmanager позволяет настраивать правила предупреждений и определять, какие действия следует предпринять при возникновении определенных событий.
6. **Push Gateway:** Push Gateway - это компонент, который позволяет приложениям "пушить" свои метрики в Prometheus, вместо того чтобы ожидать, пока Prometheus выполнит опрос. Это полезно, например, для приложений, которые не постоянно активны.

**Storage**

https://github.com/prometheus/prometheus/blob/release-2.47/tsdb/docs/format/README.md

Prometheus включает в себя локальную временную базу данных на диске, а также опционально интегрируется с удаленными системами хранения.

Локальное хранилище Локальная временная база данных Prometheus сохраняет данные в специальном, высокоэффективном формате на локальном носителе.

Размещение на диске Принятые выборки группируются в блоки по два часа. Каждый блок из двух часов состоит из каталога, содержащего подкаталог chunks с всеми выборками временных рядов для этого временного окна, файла метаданных и файла индекса (который индексирует имена метрик и метки временных рядов в каталоге chunks). Выборки в каталоге chunks группируются в один или более сегментных файлов размером до 512 МБ каждый по умолчанию. Когда ряды удаляются через API, записи об удалении сохраняются в отдельных файлах-могилах (вместо немедленного удаления данных из сегментов блока).

Текущий блок для входящих выборок хранится в памяти и не полностью сохраняется. Он защищен от сбоев журналом записи (WAL write-ahead log), который может быть воспроизведен при перезапуске сервера Prometheus. Файлы журнала записи предварительной записи хранятся в каталоге wal в сегментах размером 128 МБ. Эти файлы содержат необработанные данные, которые еще не были скомпонованы; поэтому они значительно больше обычных файлов блоков. Prometheus будет хранить не менее трех файлов журнала записи предварительной записи. Серверы с высокой нагрузкой могут хранить больше трех файлов WAL, чтобы сохранить как минимум два часа необработанных данных.

Каталог данных сервера Prometheus выглядит примерно так:
```
./data
├── 01BKGV7JBM69T2G1BGBGM6KB12
│   └── meta.json
├── 01BKGTZQ1SYQJTR4PB43C8PD98
│   ├── chunks
│   │   └── 000001
│   ├── tombstones
│   ├── index
│   └── meta.json
├── 01BKGTZQ1HHWHV8FBJXW1Y3W0K
│   └── meta.json
├── 01BKGV7JC0RY8A6MACW02A2PJD
│   ├── chunks
│   │   └── 000001
│   ├── tombstones
│   ├── index
│   └── meta.json
├── chunks_head
│   └── 000001
└── wal
    ├── 000000002
    └── checkpoint.00000001
        └── 00000000
```

Модель данных

  
Образцы представляют собой фактические данные временных рядов. Каждый образец состоит из следующих элементов:

- a float64 value
- a millisecond-precision timestamp

```
<metric_name>[ {<label_1="value_1"}>, <label_N="value_N"}>] <datapoint_numerical_value>
```
Например, временной ряд с именем метрики `api_http_requests_total` и метками `method="POST"` и `handler="/messages"` может быть записан следующим образом:

```
api_http_requests_total{method="POST", handler="/messages"}
```


### Counter
**Счетчик** – монотонно возрастающее число. Может быть сброшен в ноль, например, при рестартах сервиса, который пишет метрику.

```
http_requests_total{url="/login"} 10 
http_requests_total{url="/"} 100 

http_errors{status="500", url="/"} 3 
http_errors{status="401", url="/"} 26 
http_errors{status="400", url="/login"} 11 
http_errors{status="404", url="/admin"} 298 

jobs{type="cleanup", status="completed"} 42 
jobs{type="cleanup", status="failed"} 38
```
### Gauge
**"Стрелка"** — это двунаправленный счетчик, значение которого может как увеличиваться, так и уменьшаться.
```
http_active_requests{app="web"} 5 
http_active_requests{app="internal"} 1 

memory_swap{host="test"} 0 
memory_swap{host="prod"} 102400 
memory_usage_bytes{host="test"} 1295007744 
memory_usage_bytes{host="prod"} 5476434545 

disk_free_bytes{path="/var/www/"} 29298077696 
disk_free_bytes{path="/tmp/"} 37359484928
```

### Histogram

**Гистограмма** — агрегация чего-то самим приложением, когда нам интересно знать **распределение** величин по **заранее определенным** группам (buckets). Гистограмма считает **количество попаданий** в какую-то группу, то есть запоминает счетчики, а не сами значения.


```
http_duration_bucket{url="/", le="0.1"} 100 
http_duration_bucket{url="/", le="1"} 130 
http_duration_bucket{url="/", le="5"} 140 
http_duration_bucket{url="/", le="+Inf"} 141 

http_duration_sum{url="/"} 152.7625769 # это бонусом идет сумма всех значений, которые мы записали 
http_duration_count{url="/"} 141 # это количество значений, т.е. counter который всегда делает +1 на каждое обновление гистограммы
```

### Summary

Сводка — работает как гистограмма, но также рассчитывает квантили.
```
http_duration_summary{quantile="1"} 100 
http_duration_summary{quantile="0.99"} 4.300226799 http_duration_summary{quantile="0.95"} 2.204090024 http_duration_summary{quantile="0.5"} 0.073790038 
http_duration_summary{quantile="0.1"} 0.018127115 
http_duration_summary_sum 152.7625769 # как у гистограммы, сумма всех значений http_duration_summary_count 141 # и количество значений
```


Основное
2. Статическое и динамическое конфигурирование
3. Типы service discovery
4. Как работает интеграция с kuber
5. lebel, якоря 
6. rules
7. pushgateway
8. alerting


